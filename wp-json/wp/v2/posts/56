{"id":56,"date":"2014-07-31T11:03:29","date_gmt":"2014-07-31T18:03:29","guid":{"rendered":"http:\/\/www.codeapex.com\/?p=56"},"modified":"2021-01-12T15:41:30","modified_gmt":"2021-01-12T23:41:30","slug":"increasing-linux-vps-ram-for-free-zram-rcscript","status":"publish","type":"post","link":"http:\/\/www.codeapex.com\/increasing-linux-vps-ram-for-free-zram-rcscript\/","title":{"rendered":"Increasing Linux VPS RAM for Free Using ZRAM &#8211; rc script"},"content":{"rendered":"<h2>Situation:<\/h2>\n<p>You are reaching or exceeding the RAM limits of your Linux VPS.<\/p>\n<h2>Objective:<\/h2>\n<p>An increase in the amount of non-virtualized memory available to your applications on your VPS without resorting to paying for an upgraded VPS.<\/p>\n<h2>Plan + Execution:<\/h2>\n<p><!--more--><\/p>\n<p>Note we want an increase in the amount of fast physical memory available to our applications. Increasing virtualized memory (via an increase in swap partition or swap file sizes) would not meet our objective; though if your VPS is on SSDs then upping swap space may not be a bad option since solid state disks are substantially faster than traditional hard disks (but still not as fast as physical memory).<\/p>\n<p>One way of making more physical memory available to your applications is to be more efficient with the use of the RAM available. We can accomplish this by compressing data stored in memory; specifically we will use <a title=\"ZRAM Wikipedia\" href=\"http:\/\/en.wikipedia.org\/wiki\/Zram\" target=\"_blank\" rel=\"noopener\">ZRAM<\/a> to appropriate a percentage of total RAM as compressed block devices. Data stored in the area will be compressed and will take up less memory than if they weren&#8217;t.<\/p>\n<p>Realize though that ZRAM will put a little more load on the CPU since it now has to compress\/decompress data in that portion. So if you also reaching or exceeding the CPU limits of your VPS you should do testing to see if ZRAM helps your situation or perhaps consider actually upgrading your VPS.<\/p>\n<p>Note some commands listed below may require superuser priviledges. Either<\/p>\n<ol>\n<li>use the <code>su<\/code> command to change the login session&#8217;s owner to root; or<\/li>\n<li>prepend the commands with <code>sudo<\/code> (e.g. <code>sudo swapon -s<\/code>); or<\/li>\n<li>login as root directly<\/li>\n<\/ol>\n<h3>Checking Kernel Support:<\/h3>\n<p>In a terminal run this command:<br \/>\n<code>modprobe -nv zram<\/code><\/p>\n<p>If the result is a path to zram.ko then your kernel supports zram as a loadable module.<\/p>\n<h3>Checking if ZRAM is Already Enabled:<\/h3>\n<p>Some distributions come with ZRAM enabled by default (such as Lubuntu). Before continuing onward we should double check to ensure we are not trying to accomplish something that is already done.<br \/>\nCheck to see if the module is loaded:<br \/>\n<code>lsmod | grep zram<\/code><\/p>\n<p>If it is loaded (the result is a line starting with zram) check to see if the compressed block devices are setup and running as available swap devices:<br \/>\n<code>swapon -s<\/code><\/p>\n<p>If you see devices listed such as \/dev\/zram0, \/dev\/zram1,&#8230; then ZRAM is already running and there is nothing you need to do further.<\/p>\n<h3>Creating the Startup Script:<\/h3>\n<p>If it does not already exist create the file <strong>\/etc\/init.d\/zram<\/strong> with the following contents:<\/p>\n<pre class=\"lang:sh decode:true\" title=\"zram\">#!\/bin\/bash\r\n### BEGIN INIT INFO\r\n# Provides: zram\r\n# Required-Start:\r\n# Required-Stop:\r\n# Default-Start: 2 3 4 5\r\n# Default-Stop: 0 1 6\r\n# Short-Description: Increased Performance In Linux With zRam (Virtual Swap Compressed in RAM)\r\n# Description: Adapted from systemd scripts at https:\/\/github.com\/mystilleef\/FedoraZram\r\n# Included as part of antix-goodies package by anticapitalista &lt;antiX@operamail.com&gt;\r\n# This script was written by tradetaxfree and is found at http:\/\/crunchbanglinux.org\/forums\/topic\/15344\/zram-a-good-idea\/\r\n# Copy this script (as root) from \/usr\/local\/bin to \/etc\/init.d and then #update-rc.d zram defaults\r\n# After booting verify the module is loaded with: lsmod | grep zram\r\n### END INIT INFO\r\n\r\nstart() {\r\n    # get the number of CPUs\r\n    num_cpus=$(grep -c processor \/proc\/cpuinfo)\r\n    # if something goes wrong, assume we have 1\r\n    [ \"$num_cpus\" != 0 ] || num_cpus=1\r\n\r\n    # set decremented number of CPUs\r\n    last_cpu=$((num_cpus - 1))\r\n    \r\n    #default Factor % = 90 change this value here or create \/etc\/default\/zram\r\n    FACTOR=25\r\n    #&amp; put the above single line in \/etc\/default\/zram with the value you want\r\n\t[ -f \/etc\/default\/zram ] &amp;&amp; source \/etc\/default\/zram || true\r\n\tfactor=$FACTOR # percentage\r\n\r\n    # get the amount of memory in the machine\r\n    memtotal=$(grep MemTotal \/proc\/meminfo | awk ' { print $2 } ')\r\n    mem_by_cpu=$(($memtotal\/$num_cpus*$factor\/100*1024))\r\n\r\n    # load dependency modules\r\n    # attempt load using syntax for kernels 3.4 onwards falling back to syntax for kernels 3.1 - 3.3\r\n    if ! modprobe zram num_devices=$num_cpus &amp;&amp; ! modprobe zram zram_num_devices=$num_cpus; then\r\n      echo -e \"Your Kernel needs to be compiled with ZRAM support:\" \\\r\n      \"\\n\\nDevice Drivers --&gt; Staging Drivers --&gt; Compressed RAM block device support (M)\" \\\r\n      \"\\nDevice Drivers --&gt; Staging Drivers --&gt; Dynamic compression of swap pages and clean pagecache pages (*)\" \\\r\n      \"\\n\\nThe Liquorix Kernel (http:\/\/liquorix.net) has ZRAM support built in.\"\r\n      exit 1\r\n    fi\r\n    echo \"zram devices probed successfully\"\r\n    \r\n    # initialize the devices\r\n    for i in $(seq 0 $last_cpu); do\r\n    echo $mem_by_cpu &gt; \/sys\/block\/zram$i\/disksize\r\n    # Creating swap filesystems\r\n    mkswap \/dev\/zram$i\r\n    # Switch the swaps on\r\n    swapon -p 100 \/dev\/zram$i\r\n    done\r\n}\r\n\r\nstop() {\r\n    # get the number of CPUs\r\n    num_cpus=$(grep -c processor \/proc\/cpuinfo)\r\n\r\n    # set decremented number of CPUs\r\n    last_cpu=$((num_cpus - 1))\r\n\r\n    # Switching off swap\r\n    for i in $(seq 0 $last_cpu); do\r\n    if [ \"$(grep \/dev\/zram$i \/proc\/swaps)\" != \"\" ]; then\r\n    swapoff \/dev\/zram$i\r\n    sleep 1\r\n    fi\r\n    done\r\n\r\n    sleep 1\r\n    rmmod zram\r\n}\r\n\r\ncase \"$1\" in\r\n    start)\r\n        start\r\n        ;;\r\n    stop)\r\n        stop\r\n        ;;\r\n    restart)\r\n        stop\r\n        sleep 3\r\n        start\r\n        ;;\r\n    *)\r\n        echo \"Usage: $0 {start|stop|restart}\"\r\n        RETVAL=1\r\nesac\r\nexit $RETVAL<\/pre>\n<p>The original source of this script can be found here:<br \/>\n<a title=\"zram init script\" href=\"http:\/\/crunchbanglinux.org\/forums\/topic\/15344\/zram-a-good-idea\/\" target=\"_blank\" rel=\"noopener\">http:\/\/crunchbanglinux.org\/forums\/topic\/15344\/zram-a-good-idea\/<\/a><\/p>\n<p>The creator also notes that the latest version of the script can be found here: <a title=\"Latest Version of zram Script\" href=\"http:\/\/dl.dropbox.com\/u\/96561917\/zram.zip\">http:\/\/dl.dropbox.com\/u\/96561917\/zram.zip<\/a><\/p>\n<p>We do make some slight changes to the script.<\/p>\n<p>The if statement for the module loading has been corrected to not exit if it successfully loads using syntax for kernels 3.4 and onward.<\/p>\n<p>Additionally take note of the change we make to FACTOR in the script from the default 90 to 25. We implement this change due to the following comment from one of ZRAM&#8217;s developers (back when it was known as Compcache): <a title=\"ZRAM (Compcache) Nitin Gupta Comment\" href=\"https:\/\/code.google.com\/p\/compcache\/wiki\/CompilingAndUsingNew\">https:\/\/code.google.com\/p\/compcache\/wiki\/CompilingAndUsingNew<\/a><\/p>\n<blockquote><p><span class=\"author\">Comment by project member <a class=\"userlink\" href=\"https:\/\/code.google.com\/u\/nitingupta910@gmail.com\/\">nitingupta910@gmail.com<\/a>, <\/span> <span class=\"date\" title=\"Fri May  7 01:35:52 2010\">May 7, 2010<\/span><\/p>\n<p>@Paczesiowa: ramzswap should not be given so much of memory as its just a (virtual) swap device &#8212; it can compress only anonymous (say, process stack, heap etc.) memory. There are also other kinds of caches in the system, say filesystem cache which also require lot of memory. So, to have a good balance among all the different caches, ramzswap should not be given nearly 100% of RAM.<\/p>\n<p>Appropriate amount of ramzswap memory depends on kind of workload. For typical desktop workloads, I found 25% to work just fine (this is the default).<\/p><\/blockquote>\n<h3>Enabling the Startup Script:<\/h3>\n<p>Enable execute permissions on the startup script:<br \/>\n<code>chmod +x \/etc\/init.d\/zram<\/code><\/p>\n<p>Add the startup script to the default run level:<br \/>\n<code>update-rc.d zram defaults<\/code><\/p>\n<h3>Verify:<\/h3>\n<p>Now either run the script manually:<br \/>\n<code>\/etc\/init.d\/zram start<\/code><br \/>\nor reboot (preferred since this will test if the script auto executes on boot).<\/p>\n<p>Verify that the module is loaded:<br \/>\n<code>lsmod | grep zram<\/code><\/p>\n<p>If the result is a line starting with zram then it is loaded.<\/p>\n<p>Verify that the compressed block devices are setup and running as available swap devices:<br \/>\n<code>swapon -s<\/code><\/p>\n<p>If you see devices listed such as \/dev\/zram0, \/dev\/zram1,&#8230; then the compressed block devices are enabled as swap devices and the setup of ZRAM is complete.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Situation: You are reaching or exceeding the RAM limits of your Linux VPS. Objective: An increase in the amount of non-virtualized memory available to your applications on your VPS without resorting to paying for an upgraded VPS. Plan + Execution:<\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"_genesis_hide_title":false,"_genesis_hide_breadcrumbs":false,"_genesis_hide_singular_image":false,"_genesis_hide_footer_widgets":false,"_genesis_custom_body_class":"","_genesis_custom_post_class":"","_genesis_layout":""},"categories":[1],"tags":[],"_links":{"self":[{"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/posts\/56"}],"collection":[{"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/comments?post=56"}],"version-history":[{"count":0,"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/posts\/56\/revisions"}],"wp:attachment":[{"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/media?parent=56"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/categories?post=56"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/tags?post=56"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}
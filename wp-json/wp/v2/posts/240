{"id":240,"date":"2021-07-26T10:10:47","date_gmt":"2021-07-26T17:10:47","guid":{"rendered":"https:\/\/www.codeapex.com\/?p=240"},"modified":"2021-07-26T10:10:47","modified_gmt":"2021-07-26T17:10:47","slug":"deleting-duplicate-rows-in-sql","status":"publish","type":"post","link":"http:\/\/www.codeapex.com\/deleting-duplicate-rows-in-sql\/","title":{"rendered":"Deleting Duplicate Rows In SQL"},"content":{"rendered":"<h2>Situation:<\/h2>\n<p>There is a table in our SQL database which contains rows which we consider duplicate based upon the values in some or all of the columns.<\/p>\n<p>We wish to delete these duplicate rows.<\/p>\n<h2>Objective:<\/h2>\n<p>To demonstrate and explain a short memorable method of deleting duplicate rows in a SQL database table using a common table expression and a window function.<\/p>\n<p>Specifically if columns <code>[col1],[col2],[col5]<\/code> define uniqueness for some table, say <code>dbo.Table<\/code>, the following query will delete duplicates:<\/p>\n<p><code>;WITH CTE AS(<br \/>\nSELECT ROW_NUMBER()OVER(PARTITION BY col1, col2, col5 ORDER BY col1, col2, col5) AS RN<br \/>\nFROM dbo.Table<br \/>\n)<br \/>\nDELETE FROM CTE WHERE RN &gt; 1<\/code><\/p>\n<h2>Plan:<\/h2>\n<p>First we define which columns being the same between rows implies the rows are duplicate or in other words what columns taken together we want unique across the table.<\/p>\n<p>Next we partition and enumerate each set of unique rows using a common table expression (CTE) and the window function <code>ROW_NUMBER()OVER()<\/code>.<\/p>\n<p>What this means is we are partitioning the rows into sets of the same row and for each partition assigning a 1 to the first row in the partition, 2 to the next row in the partition, 3 in the next row in the partition, and so on; call this number RN.<\/p>\n<p>Then we delete all such rows where the row number is greater than 1 (RN &gt; 1).<\/p>\n<h2>Execution:<\/h2>\n<p><strong>Example Table:<\/strong> <code>dbo.Table<\/code><\/p>\n<table class=\"sqloutput\">\n<tbody>\n<tr>\n<th><\/th>\n<th>col1<\/th>\n<th>col2<\/th>\n<th>col3<\/th>\n<th>col4<\/th>\n<th>col5<\/th>\n<\/tr>\n<tr>\n<td>1<\/td>\n<td>Alpha<\/td>\n<td>1<\/td>\n<td>1<\/td>\n<td>CO<\/td>\n<td>42<\/td>\n<\/tr>\n<tr>\n<td>2<\/td>\n<td>Alpha<\/td>\n<td>1<\/td>\n<td>1<\/td>\n<td>CO<\/td>\n<td>42<\/td>\n<\/tr>\n<tr>\n<td>3<\/td>\n<td>Beta<\/td>\n<td>2<\/td>\n<td>2<\/td>\n<td>MN<\/td>\n<td>29<\/td>\n<\/tr>\n<tr>\n<td>4<\/td>\n<td>Beta<\/td>\n<td>2<\/td>\n<td>2<\/td>\n<td>MN<\/td>\n<td>29<\/td>\n<\/tr>\n<tr>\n<td>5<\/td>\n<td>Beta<\/td>\n<td>2<\/td>\n<td>2<\/td>\n<td>MN<\/td>\n<td>37<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n<p><strong>Define uniqueness \/ duplicate:<\/strong><\/p>\n<p>Let&#8217;s say a certain set of columns from the table taken together should be unique across the table; say columns <code>[col1],[col2],[col5]<\/code>.<\/p>\n<p><strong>Enumeration \/ CTE part of query:<\/strong><\/p>\n<p>We create a CTE for our table that partitions the rows into sets of the same row and enumerates each partition.<\/p>\n<p>The result of the CTE should look like this:<\/p>\n<table class=\"sqloutput\">\n<tbody>\n<tr>\n<th><\/th>\n<th>col1<\/th>\n<th>col2<\/th>\n<th>col3<\/th>\n<th>col4<\/th>\n<th>col5<\/th>\n<th>RN<\/th>\n<\/tr>\n<tr>\n<td>1<\/td>\n<td>Alpha<\/td>\n<td>1<\/td>\n<td>1<\/td>\n<td>CO<\/td>\n<td>42<\/td>\n<td>1<\/td>\n<\/tr>\n<tr>\n<td>2<\/td>\n<td>Alpha<\/td>\n<td>1<\/td>\n<td>1<\/td>\n<td>CO<\/td>\n<td>42<\/td>\n<td>2<\/td>\n<\/tr>\n<tr>\n<td>3<\/td>\n<td>Beta<\/td>\n<td>2<\/td>\n<td>2<\/td>\n<td>MN<\/td>\n<td>29<\/td>\n<td>1<\/td>\n<\/tr>\n<tr>\n<td>4<\/td>\n<td>Beta<\/td>\n<td>2<\/td>\n<td>2<\/td>\n<td>MN<\/td>\n<td>29<\/td>\n<td>2<\/td>\n<\/tr>\n<tr>\n<td>5<\/td>\n<td>Beta<\/td>\n<td>2<\/td>\n<td>2<\/td>\n<td>MN<\/td>\n<td>37<\/td>\n<td>1<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n<p>A CTE that accomplishes this is:<\/p>\n<p><code>;WITH CTE AS(<br \/>\nSELECT col1, col2, col5,<br \/>\nROW_NUMBER()OVER(PARTITION BY col1, col2, col5 ORDER BY col1, col2, col5) AS RN<br \/>\nFROM dbo.Table<br \/>\n)<\/code><\/p>\n<p>The key part is we PARTITION BY the columns that define uniqueness.<\/p>\n<p><strong>Deletion part of query:<\/strong><\/p>\n<p>Using our CTE we delete the rows from the table where RN &gt; 1 as such rows are duplicate.<\/p>\n<p><code>DELETE FROM CTE WHERE RN &gt; 1<\/code><\/p>\n<p><strong>Result:<\/strong><\/p>\n<p>After deletion our example table would look like this:<\/p>\n<table class=\"sqloutput\">\n<tbody>\n<tr>\n<th><\/th>\n<th>col1<\/th>\n<th>col2<\/th>\n<th>col3<\/th>\n<th>col4<\/th>\n<th>col5<\/th>\n<\/tr>\n<tr>\n<td>1<\/td>\n<td>Alpha<\/td>\n<td>1<\/td>\n<td>1<\/td>\n<td>CO<\/td>\n<td>42<\/td>\n<\/tr>\n<tr>\n<td>2<\/td>\n<td>Beta<\/td>\n<td>2<\/td>\n<td>2<\/td>\n<td>MN<\/td>\n<td>29<\/td>\n<\/tr>\n<tr>\n<td>3<\/td>\n<td>Beta<\/td>\n<td>2<\/td>\n<td>2<\/td>\n<td>MN<\/td>\n<td>37<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n<h2>Conclusion:<\/h2>\n<p>For the CTE some of the columns in the SELECT portion are optional and were included for illustrative purposes only.<\/p>\n<p>Specifically only the RN column is needed since the DELETE statement only works with RN.<\/p>\n<p>Consequently the others can be dropped from the query without altering the end result giving us our final query:<\/p>\n<p><strong>Final query:<\/strong><\/p>\n<p><code>;WITH CTE AS(<br \/>\nSELECT ROW_NUMBER()OVER(PARTITION BY col1, col2, col5 ORDER BY col1, col2, col5) AS RN<br \/>\nFROM dbo.Table<br \/>\n)<br \/>\nDELETE FROM CTE WHERE RN &gt; 1<\/code><\/p>\n","protected":false},"excerpt":{"rendered":"<p>Situation: There is a table in our SQL database which contains rows which we consider duplicate based upon the values in some or all of the columns. We wish to delete these duplicate rows. Objective: To demonstrate and explain a short memorable method of deleting duplicate rows in a SQL database table using a common [&hellip;]<\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"_genesis_hide_title":false,"_genesis_hide_breadcrumbs":false,"_genesis_hide_singular_image":false,"_genesis_hide_footer_widgets":false,"_genesis_custom_body_class":"","_genesis_custom_post_class":"","_genesis_layout":""},"categories":[1],"tags":[],"_links":{"self":[{"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/posts\/240"}],"collection":[{"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/comments?post=240"}],"version-history":[{"count":26,"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/posts\/240\/revisions"}],"predecessor-version":[{"id":266,"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/posts\/240\/revisions\/266"}],"wp:attachment":[{"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/media?parent=240"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/categories?post=240"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/www.codeapex.com\/wp-json\/wp\/v2\/tags?post=240"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}